name: Optimize Images in /rumah

on:
  push:
    paths:
      - "rumah/**.png"
      - "rumah/**.jpg"
      - "rumah/**.jpeg"
      - "rumah/**.gif"
      - "rumah/**.bmp"
      - "rumah/**.tif"
      - "rumah/**.tiff"
      - "rumah/**.webp"
  workflow_dispatch:

jobs:
  optimize-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install WebP tools
        run: |
          sudo apt-get update
          sudo apt-get install -y webp

      # 1) Convert gambar → WEBP
      - name: Convert images in /rumah to WebP
        run: |
          find rumah -type f \( \
            -iname "*.png"  -o \
            -iname "*.jpg"  -o \
            -iname "*.jpeg" -o \
            -iname "*.gif"  -o \
            -iname "*.bmp"  -o \
            -iname "*.tif"  -o \
            -iname "*.tiff" \
          \) | while read img; do
            webp="${img%.*}.webp"
            echo "Convert: $img -> $webp"
            cwebp -q 80 "$img" -o "$webp"
          done

      # 2) Recompress WebP
      - name: Recompress WebP in /rumah
        run: |
          find rumah -type f -iname "*.webp" | while read img; do
            tmp="${img%.webp}.tmp.webp"
            echo "Compress: $img"
            cwebp -q 75 "$img" -o "$tmp"
            mv "$tmp" "$img"
          done

      # 3) Hapus semua gambar non-WEBP
      - name: Remove non-WebP images from /rumah
        run: |
          echo "Deleting original non-WebP files..."
          find rumah -type f \( \
            -iname "*.png"  -o \
            -iname "*.jpg"  -o \
            -iname "*.jpeg" -o \
            -iname "*.gif"  -o \
            -iname "*.bmp"  -o \
            -iname "*.tif"  -o \
            -iname "*.tiff" \
          \) -print -delete

      # 4) Commit hasilnya
      - name: Commit optimized images
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Optimize rumah images → WebP & remove originals"
          add_options: "-A"
          file_pattern: "rumah"
